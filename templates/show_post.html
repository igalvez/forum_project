{% macro show_comments(parent_id) %}
	{% set clist = get_comments(post.id,parent_id) %}
	{% if clist is defined %}
		{% for c in clist %}
			<div class='well'>
				<a href="comment{{c.id}}" data-toggle="collapse">[+]</a> &nbsp;&nbsp;
				{% if c.user_id!=0 %}
					{% set author = get_author(c.user_id) %}
					{% if author=="" %}
						Author: {{ author }}
					{% else %}
						<a href="{{ url_for('show_user',user_id=c.user_id) }}"> Author: {{ author }} </a> <br/>
					{% endif %}
				{% endif %}
				<div id="comment{{c.id}}" class="collapse in">
					{{ prefix }}
					{{ c.message }}
					<br/>
					{% if session["uid"] %}
						<a href="javascript:void(0)" onclick="show_hidden('write_comment{{c.id}}')"> comment </a>
					{% endif %}
					{% if (session["uid"]==c.user_id or session["uid"]==sub.admin_id) %}
						&nbsp &nbsp <a href="{{ url_for('delete_comment', sid=sub.id, pid=post.id, cid=c.id) }}"> delete </a>
					{% endif %}
					<div id="write_comment{{c.id}}" style="display: none;">
						<form action="#" onsubmit="post_comment(event, 'message{{c.id}}','subcomment{{c.id}}','{{c.id}}','{{post.id}}','{{sub.id}}')">
							<textarea id="message{{c.id}}" name='message' rows='10' cols='30'></textarea>
							<br/><br/>
							<input type='submit' value='ok' onclick="show_hidden('write_comment{{c.id}}')"/>
						</form>
					</div>
					<div id="subcomment{{c.id}}" style="display: none;">
					</div>
					<br/><br/>
					{{ show_comments(c.id) }}
				</div>
			</div>
		{% endfor %}
	{% endif %}
{% endmacro %}

{% extends "header.html" %}

{% block header %}
{% endblock %}
{% block title %}
{{ post.title }}
{% endblock %}

{% block body %}
	{{ super() }}
	<script>
		function show_hidden(uid) {
			let div = document.getElementById(uid);
			if (div.style.display == "none") {
				div.style.display = "block";
			} else {
				div.style.display = "none";
			}
		}

		function post_comment(event, msgId, divId, cid, pid, sid) {
			let xhttp = new XMLHttpRequest();
			console.log("ON POST COMMENT")
			let div = document.getElementById(divId);
			
			let msg = document.getElementById(msgId);
			console.log("message is " + msg.value )
			//div.innerHTML = "TESTE 123"
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					div.style = "block";
					let ncid = this.responseText;

					let div_innerHTML = "<div class=\"well\">\n";
					div_innerHTML +=    "	<a href=\"comment" + ncid + "\" data-toggle=\"collapse\">[+]</a> &nbsp;&nbsp;";
					//div_innerHTML += "Author: <a href=\"" +  + "</a> <br>\n";
					div_innerHTML +=    "	<div id=\"comment" + ncid + "\" class=\"collapse in\">";
					div_innerHTML +=    "   	" + msg.value + "<br>";
					div_innerHTML +=    "      <a href=\"javascript:void(0)\" onclick=\"show_hidden('write_comment" + ncid + "')\"> comment </a>";
					div_innerHTML +=    "	    &nbsp &nbsp <a href=\"#\"> delete </a>";
					div_innerHTML +=    "      <div id=\"write_comment" + ncid + "\" style=\"display: none;\">";
					div_innerHTML +=    "			<form action = \"#\" onsubmit=\"post_comment(event, 'message"+ncid+"','subcomment"+ncid+"','"+ncid+"','"+pid+"','"+sid+"')\">"
					div_innerHTML +=    "				<textarea id='message"+ncid+"' name='message' rows='10' cols='30'></textarea> <br><br>";
					div_innerHTML +=    "				<input type='submit' onclick=\"show_hidden('write_comment"+ncid+"')\"/>";
					div_innerHTML +=    "		    </form>";
					div_innerHTML +=    "		</div>";
					div_innerHTML +=    "      <div id=\"subcomment"+ncid+"\" style=\"display: none;\"></div>"
					div_innerHTML +=    "	</div>";
					div_innerHTML +=    "</div>";
					div.innerHTML += div_innerHTML;
					msg.value = "";

					//div.innerHTML = "TEST 456"
				}
			};
			let url = "/sub/" + sid + "/post/" + pid + "/" + cid + "/postcomment/";
			let content = "message=" + msg.value;
			xhttp.open("POST", url, true);
			xhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
			console.log("url is" + url);
			xhttp.send(content);
			event.preventDefault();
		}
	</script>
	<br/><br/>
	<h2> {{ post.title }} </h2>
	<br/>
	Author: {{ get_author(post.user_id) }} <br/>
	{{ post.message }}
	<br/><br/><br/>
	{{ show_comments(0) }}
	<br/>
	<a href="{{ url_for('write_comment',sid=sub.id, pid=post.id, cid=0)}}">Comment </a>
	<br/><br/>
	<a href="{{ url_for('show_sub',sid=sub.id) }}"> Back </a>

{% endblock %}
